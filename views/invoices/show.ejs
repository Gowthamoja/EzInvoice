<% layout('/layouts/boilerplate') %>

    <div class="container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white w-100 py-3 px-2 border-bottom"
                style="top: 70px; z-index: 1020;">
            <div class="inv">
                <a href="/invoices" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-chevron-left small"></i> </a>
                <h3 class="fw-bold">Invoice <%= invoice.invoiceNumber %>
                </h3>
            </div>

            <div class="btn-group">
                <a href="/invoices/<%= invoice._id %>/edit" class="btn btn-outline-primary me-2"><i
                        class="bi bi-pencil"></i> Edit</a>
                        <form id="deleteForm" method="POST" action="/invoices/<%= invoice.id %>?_method=DELETE" class="me-2">
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
            <i class="bi bi-trash"></i> Delete
        </button>
    </form>
                <button id="printInvoiceBtn" class="btn btn-primary"><i class="bi bi-printer"></i> Print or
                    Download</button>
            </div>
        </div>

        <div class="card p-4 shadow-sm">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-start mb-5 pb-3 border-bottom">
                    <div>
                        <h2 class="fw-bolder mb-0">INVOICE</h2>
                        <p class="text-muted mt-1 mb-0 small"># <%= invoice.invoiceNumber %>
                        </p>
                    </div>
                    <div>
                        <p class="small text-muted mb-1 text-end">Status</p>
                        <% let status=invoice.status ? invoice.status.toLowerCase() : 'unpaid' ; let
                            statusClass=status==='paid' ? 'success' : 'danger' ; %>
                            <span
                                class="badge text-bg-<%= statusClass %> bg-opacity-25 text-<%= statusClass %> fw-bold p-2">
                                <%= status.charAt(0).toUpperCase() + status.slice(1) %>
                            </span>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-md-6">
                        <p class="small text-uppercase text-muted mb-2 fw-bold">Bill From</p>
                        <p class="fw-bold mb-1">
                            <%= invoice.billFrom.businessName %>
                        </p>
                        <p class="mb-1">
                            <%= invoice.billFrom.address %>
                        </p>
                        <p class="mb-1 text-primary">
                            <%= invoice.billFrom.email %>
                        </p>
                        <p class="mb-0">
                            <%= invoice.billFrom.phone %>
                        </p>
                    </div>

                    <div class="col-md-6 text-end">
                        <p class="small text-uppercase text-muted mb-2 fw-bold">Bill To</p>
                        <p class="fw-bold mb-1">
                            <%= invoice.billTo.clientName %>
                        </p>
                        <p class="mb-1">
                            <%= invoice.billTo.address %>
                        </p>
                        <p class="mb-1 text-primary">
                            <%= invoice.billTo.email %>
                        </p>
                        <p class="mb-0">
                            <%= invoice.billTo.phone %>
                        </p>
                    </div>
                </div>

                <div class="row text-muted border-top pt-3 mb-5">
                    <div class="col-md-4">
                        <p class="small text-uppercase mb-1">Invoice Date</p>
                        <p class="fw-bold fs-5">
                            <% const invDate=new Date(invoice.invoiceDate); %>
                                <%= invDate.toLocaleDateString('en-IN', {day: '2-digit' , month: '2-digit' ,
                                    year: 'numeric' }) %>
                        </p>
                    </div>
                    <div class="col-md-4">
                        <p class="small text-uppercase mb-1">Due Date</p>
                        <p class="fw-bold fs-5">
                            <% 
                                dueDate=invoice.dueDate ? new Date(invoice.dueDate) : 'N/A' ; %>
                                <%= dueDate==='N/A' ? dueDate : dueDate.toLocaleDateString('en-IN', {day: '2-digit' ,
                                    month: '2-digit' , year: 'numeric' }) %>
                        </p>
                    </div>
                    <div class="col-md-4">
                        <p class="small text-uppercase mb-1">Payment Terms</p>
                        <p class="fw-bold fs-5">
                            <%= invoice.paymentTerms %>
                        </p>
                    </div>
                </div>

                <table class="table mb-0 table-hover table-borderless invoice-items-table">
                    <thead class="bg-light fw-bold">
                        <tr class="table-secondary">
                            <th class="py-3 small text-uppercase" scope="col">Item</th>
                            <th class="py-3 small text-uppercase text-end" scope="col">Qty</th>
                            <th class="py-3 small text-uppercase text-end" scope="col">Price</th>
                            <th class="py-3 small text-uppercase text-end" scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(let item of invoice.items) { %>
                            <tr>
                                <td class="fw-normal">
                                    <%= item.name %>
                                </td>
                                <td class="text-end">
                                    <%= item.quantity || 0 %>
                                </td>
                                <td class="text-end">&#8377; <%= (item.unitPrice || 0).toLocaleString('en-IN') %>
                                </td>
                                <td class="text-end">&#8377; <%= (item.total || 0).toLocaleString("en-IN") %>
                                </td>
                            </tr>
                            <% } %>
                    </tbody>
                </table>

                <div class="row justify-content-end mt-4">
                    <div class="col-md-5">
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="display-7">Subtotal</span>
                            <span class="fw-normal">&#8377; <%= (invoice.subTotal || invoice.subtotal ||
                                    0).toLocaleString("en-IN") %></span>
                        </div>
                        <div class="d-flex justify-content-between py-1 small">
                            <span>Tax</span>
                            <span class="fw-normal">&#8377; <%= (invoice.taxTotal || 0).toLocaleString("en-IN") %>
                                    </span>
                        </div>
                        <div class="d-flex justify-content-between py-2 mt-2 border-top">
                            <span class="fs-5 fw-bold">Total</span>
                            <span class="fs-5 fw-bold text-primary">&#8377; <%= (invoice.total ||
                                    0).toLocaleString("en-IN") %></span>
                        </div>
                    </div>
                </div>

            </div>
        </div>


        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you absolutely sure you want to permanently delete Invoice <b><%= invoice.invoiceNumber %> </b> ? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Permanently</button>
            </div>
        </div>
    </div>
</div>
    </div>

    <style>
        /* .show {
        /* display: none; */
        /* color: #0D6EFD; */
        /* } */
        .shows {
            color: white;
            background-color: #0D6EFD;
            /* text-decoration: underline; */
        }

        .edit {
            display: none;
        }

        .link {
            transition: background-color 0.3s, color 0.3s;
        }

        .link:hover {
            background-color: #0D6EFD;
            color: white;

        }


        @media print {
            body * {
                visibility: hidden;
            }

            .card,
            .card * {
                visibility: visible;
            }

            .card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }

            .btn,
            .btn * {
                display: none !important;
            }
        }

        .inv {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const printButton = document.getElementById('printInvoiceBtn');

            if (printButton) {
                printButton.addEventListener('click', function () {
                    window.print();
                });
            }
        });
    document.addEventListener('DOMContentLoaded', function() {

        const printButton = document.getElementById('printInvoiceBtn');
        
        if (printButton) {
            printButton.addEventListener('click', function() {
                window.print();
            });
        }
        
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteForm = document.getElementById('deleteForm');

        if (confirmDeleteBtn && deleteForm) {
            confirmDeleteBtn.addEventListener('click', function() {
                deleteForm.submit();
            });
        }
    });
</script>